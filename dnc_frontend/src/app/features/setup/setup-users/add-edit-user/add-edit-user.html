<h2 mat-dialog-title class="title">
  <mat-icon aria-hidden="true">person</mat-icon>
  <span>{{ isEdit ? 'Edit User' : 'New User' }}</span>
</h2>

<div mat-dialog-content class="content">
  <div class="grid">
    <!-- Left: editable fields -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">User details</div>
        <div class="panel-subtitle">Update identity and access for this account.</div>
      </div>

      <mat-divider></mat-divider>

      <form class="form" [formGroup]="form" (ngSubmit)="save()">
        <mat-form-field appearance="outline">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" (keydown.enter)="onEnter()" />
          <mat-hint>Full name as it should appear in the system</mat-hint>
          @if (form.controls.name.hasError('required')){
            <mat-error >Name is required</mat-error>
          }
          @if(form.controls.name.hasError('maxlength')){
            <mat-error >Name is too long</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" (keydown.enter)="onEnter()" />
          <mat-hint>Used for login and notifications</mat-hint>
          @if (form.controls.email.hasError('required')){
            <mat-error>Email is required</mat-error>
          }
          @if (form.controls.email.hasError('email')){
            <mat-error >Enter a valid email</mat-error>
          }
          @if (form.controls.email.hasError('maxlength')){
            <mat-error >Email is too long</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Role</mat-label>
          <mat-select formControlName="role_id">
            @for(r of data.roles; track r.id){
              <mat-option [value]="r.id">
                {{ r.name }}
              </mat-option>
            }
          </mat-select>

          @if (selectedRoleName()){
            <mat-hint>
              Selected: {{ selectedRoleName() }}
            </mat-hint>
          }
          @if(form.controls.role_id.hasError('required')){
            <mat-error >Role is required</mat-error>
          }
        </mat-form-field>
      </form>
    </section>

    <!-- Right: read-only/audit -->
    <aside class="panel audit">
      <div class="panel-header">
        <div class="panel-title">Audit</div>
        <div class="panel-subtitle">Read-only metadata</div>
      </div>

      <mat-divider></mat-divider>

      <div class="audit-grid">
        <div class="audit-row">
          <div class="audit-label">User ID</div>
          <div class="audit-value">
            <span class="mono">{{ data.user?.id ?? '—' }}</span>
          </div>
        </div>

        <div class="audit-row">
          <div class="audit-label">Last modified by</div>
          <div class="audit-value">
            {{ data.user?.last_modified_by ?? '—' }}
          </div>
        </div>

        <div class="audit-row">
          <div class="audit-label">Last modified on</div>
          <div class="audit-value">
            {{ data.user?.last_modified_on ? (data.user!.last_modified_on | date:'medium') :  '—' }}
          </div>
        </div>

        <div class="audit-row">
          <div class="audit-label">Current role</div>
          <div class="audit-value">
            {{ data.user?.role ?? (selectedRoleName() || '—') }}
          </div>
        </div>
      </div>

      <div class="audit-note">
        <mat-icon aria-hidden="true">info</mat-icon>
        <span>
          ID and audit fields are system-controlled and cannot be edited.
        </span>
      </div>
    </aside>
  </div>
</div>

<div mat-dialog-actions align="end" class="actions">
  <button mat-button type="button" (click)="close()">Cancel</button>
  <button
    mat-flat-button
    color="primary"
    type="button"
    (click)="save()"
    [disabled]="form.invalid"
  >
    {{ isEdit ? 'Save changes' : 'Create user' }}
  </button>
</div>
