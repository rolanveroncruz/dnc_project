<h2 mat-dialog-title class="dialog-title">
  <div class="title-wrap">
    <div class="title-text">
      <div class="title">{{ title() }}</div>
      <div class="subtitle">{{ subtitle() }}</div>
    </div>

    @if (hasChanges) {
      <span class="status-chip">Unsaved changes</span>
    }
  </div>
</h2>

<div mat-dialog-content class="dialog-content">
  <form [formGroup]="form" class="grid">
    <!-- LEFT: Editable -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Role permission</div>
        <div class="panel-hint">Select a role, an object, and allowed actions.</div>
      </div>

      <div class="grid-2">
        <mat-form-field appearance="outline" class="full">
          <mat-label>Role *</mat-label>
          <mat-select formControlName="role_id" required>
            @for (r of data.roles; track r.id) {
              <mat-option [value]="r.id">{{ r.name }}</mat-option>
            }
          </mat-select>
          @if (roleCtrl.touched && roleCtrl.invalid) {
            <mat-error>Role is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Object *</mat-label>
          <mat-select formControlName="data_object_id" required>
            @for (o of data.objects; track o.id) {
              <mat-option [value]="o.id">{{ o.label ?? o.name }}</mat-option>
            }
          </mat-select>
          @if (objectCtrl.touched && objectCtrl.invalid) {
            <mat-error>Object is required</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="actions-card" formGroupName="actions">
        <div class="actions-card-header">
          <div class="actions-title">Actions</div>
          <div class="actions-hint">Choose what this role can do for the selected object.</div>
        </div>

        <div class="actions-row">
          <mat-checkbox formControlName="create">Create</mat-checkbox>
          <mat-checkbox formControlName="read">Read</mat-checkbox>
          <mat-checkbox formControlName="update">Update</mat-checkbox>
        </div>

        @if (!hasAnyAction) {
          <div class="actions-warning">
            <mat-icon aria-hidden="true">info</mat-icon>
            <span>Select at least one action.</span>
          </div>
        }
      </div>
    </section>

    <!-- RIGHT: Readonly meta -->
    <aside class="panel panel--meta">
      <div class="panel-header">
        <div class="panel-title">Audit</div>
        <div class="panel-hint">Read-only information.</div>
      </div>

      <div class="meta-row">
        <div class="meta-label">Mode</div>
        <div class="meta-value">{{ mode === 'add' ? 'Add' : 'Edit' }}</div>
      </div>

      <div class="meta-row">
        <div class="meta-label">Permission ID</div>
        <div class="meta-value mono">
          @if (data.row?.id) { #{{ data.row?.id }} } @else { — }
        </div>
      </div>

      <div class="meta-row">
        <div class="meta-label">Selected role</div>
        <div class="meta-value">{{ selectedRoleName }}</div>
      </div>

      <div class="meta-row">
        <div class="meta-label">Selected object</div>
        <div class="meta-value">{{ selectedObjectLabel }}</div>
      </div>

      <div class="meta-row">
        <div class="meta-label">Last modified by</div>
        <div class="meta-value">{{ data.row?.last_modified_by ?? '—' }}</div>
      </div>

      <div class="meta-row">
        <div class="meta-label">Last modified on</div>
        <div class="meta-value">
          {{ data.row?.last_modified_on ? (data.row?.last_modified_on | date:'medium') : '—' }}
        </div>
      </div>
    </aside>
  </form>
</div>

<div mat-dialog-actions class="dialog-actions" align="end">
  <button mat-button type="button" (click)="cancel()">Cancel</button>

  <button
    mat-flat-button
    type="button"
    (click)="save()"
    [disabled]="form.invalid || !hasAnyAction || !hasChanges"
  >
    Save
  </button>
</div>
